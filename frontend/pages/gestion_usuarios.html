<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inicio | Ministerio de Educación Pública</title>
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/header.css">
    <link rel="stylesheet" href="../css/footer.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>

<body>
    <div id="header"></div>
        <main class="container my-5">
            <h2>Gestión de Usuarios</h2>
            <section class="user-list">
                <h3>Lista de Usuarios</h3>
                <table id="usersTable" class="table table-bordered table-striped table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Activo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Usuarios serán incluidos con JS -->
                    </tbody>
                </table>
            </section>
            <section class="user-actions">
                <h3>Acciones</h3>
                <button onclick="mostrarFormularioRegistro()" class="btn-mep">Registrar Nuevo Usuario</button>
            </section>
            <section id="editUserSection" style="display: none;">
                <h3>Editar Usuario</h3>
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    
                    <label for="editNombre">Nombre:</label>
                    <input type="text" id="editNombre" name="nombre" required>
                    
                    <label for="editEmail">Correo Electrónico:</label>
                    <input type="email" id="editEmail" name="email" required>
                    
                    <label for="editPassword">Contraseña (dejar en blanco para no cambiar):</label>
                    <input type="password" id="editPassword" name="password">
                    
                    <label for="editRol">Rol:</label>
                    <select id="editRol" name="rol" style="margin-top: 0.5rem;" required>
                        <option value="admin">Administrador</option>
                        <option value="docente">Docente</option>
                        <option value="padre">Padre de Familia</option>
                    </select>
                    
                    <label for="editActivo">Activo:</label>
                    <select id="editActivo" name="activo" required>
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                    
                    <button type="submit" class="btn-mep azul">Guardar Cambios</button>
                    <button type="button" class="btn-mep" onclick="cancelarEdicion()">Cancelar</button>
                </form>
                <p id="editMessage"></p>
            </section>
        </main>
        <script>
            // JavaScript para cargar y mostrar usuarios
            const backendUrl = 'http://localhost:3000/usuarios';
            async function cargarUsuarios() {
                const respuesta = await fetch(`${backendUrl}/users`);
                const usuarios = await respuesta.json();
                const cuerpoTabla = document.querySelector('#usersTable tbody');
                cuerpoTabla.innerHTML = '';
                usuarios.forEach(usuario => {
                    const fila = document.createElement('tr');
                    fila.innerHTML = `
                        <td>${usuario.nombre}</td>
                        <td>${usuario.email}</td>
                        <td>${usuario.rol}</td>
                        <td>${usuario.activo ? 'Sí' : 'No'}</td>
                        <td>
                            <button class="btn-mep azul" onclick="editarUsuario('${usuario._id}')">Editar</button>
                            <button class="btn-mep azul" onclick="desactivarUsuario('${usuario._id}')">Desactivar</button>
                        </td>
                    `;
                    cuerpoTabla.appendChild(fila);
                });
            }

            function mostrarFormularioRegistro() {
                // Redirigir a la página de registro o mostrar formulario
                window.location.href = '/frontend/pages/registro.html';
            }

            async function editarUsuario(id) {
            try {
                const respuesta = await fetch(`${backendUrl}/users/${id}`);
                if (!respuesta.ok) {
                    throw new Error('Usuario no encontrado');
                }
                const usuario = await respuesta.json();

                // Rellenar el formulario con los datos del usuario
                document.getElementById('editUserId').value = usuario._id;
                document.getElementById('editNombre').value = usuario.nombre;
                document.getElementById('editEmail').value = usuario.email;
                document.getElementById('editRol').value = usuario.rol;
                document.getElementById('editActivo').value = usuario.activo.toString();
                document.getElementById('editPassword').value = ''; // Contraseña en blanco por defecto

                // Mostrar la sección de edición
                document.getElementById('editUserSection').style.display = 'block';
            } catch (err) {
                alert('Error al obtener datos del usuario: ' + err.message);
            }
            }

            // Función para cancelar la edición
            function cancelarEdicion() {
                document.getElementById('editUserSection').style.display = 'none';
                document.getElementById('editMessage').textContent = '';
            }

            // Función para manejar el envío del formulario de edición
            async function guardarCambiosUsuario(event) {
                event.preventDefault();

                const id = document.getElementById('editUserId').value;
                const nombre = document.getElementById('editNombre').value;
                const email = document.getElementById('editEmail').value;
                const password = document.getElementById('editPassword').value;
                const rol = document.getElementById('editRol').value;
                const activo = document.getElementById('editActivo').value === 'true';
                const mensaje = document.getElementById('editMessage');

                const body = { nombre, email, rol, activo };
                if (password) {
                    body.password = password; // Solo incluir contraseña si se proporciona
                }

                try {
                    const respuesta = await fetch(`${backendUrl}/users/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(body),
                    });

                    const datos = await respuesta.json();

                    if (respuesta.ok) {
                        mensaje.style.color = 'green';
                        mensaje.textContent = 'Usuario actualizado con éxito';
                        cancelarEdicion();
                        cargarUsuarios(); // Recargar la lista de usuarios
                    } else {
                        mensaje.style.color = 'red';
                        mensaje.textContent = datos.message;
                    }
                } catch (err) {
                    mensaje.style.color = 'red';
                    mensaje.textContent = 'Error al conectar con el servidor';
                    console.error('Error:', err);
                }
            }
            document.getElementById('editUserForm').addEventListener('submit', guardarCambiosUsuario);
            async function desactivarUsuario(id) {
                await fetch(`${backendUrl}/users/${id}/deactivate`, { method: 'PUT' });
                cargarUsuarios();
            }

            window.onload = cargarUsuarios;
        </script>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <script src="../js/index.js"></script>

</body>

</html>